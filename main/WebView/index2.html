<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <style>
      body {
        margin: 2rem;
        background: #eee;
      }

      canvas {
        background: white;
        box-shadow: 0px 2px 3px rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="d-flex flex-row">
        <canvas
          id="canvas"
          width="800px"
          height="800px"
          @click="clickPosition"
        ></canvas>
        <div class="form-group ml-2">
          <h1>新增可走區域</h1>
          <button class="btn btn-primary btn-block">show</button>
          <label for="">X</label>
          <input
            type="text"
            class="form-control"
            aria-describedby="helpId"
            placeholder=""
            v-model="mouse.x"
          />
          <label for="">Y</label>
          <input
            type="text"
            class="form-control"
            aria-describedby="helpId"
            placeholder=""
            v-model="mouse.y"
          />
          <button
            class="btn btn-primary mt-2"
            @click="prePoint()"
            v-if="nowPointIndex>0"
          >
            上個點{{nowPointIndex}}
          </button>
          <button
            class="btn btn-primary mt-2"
            @click="nextPoint()"
            v-if="nowPointIndex!=3"
          >
            下個點{{nowPointIndex}}
          </button>
          <button
            class="btn btn-primary mt-2"
            @click="PostWalk()"
            v-if="nowPointIndex==3"
          >
            送出
          </button>
        </div>
      </div>
    </div>

    <!-- <drawing-board></drawing-board> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.20.0/axios.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.12/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.js"></script>
    <script>
      var app = new Vue({
        el: "#app",
        data: {
          input: {
            x: 0,
            y: 0,
            x1: 0,
            y1: 0,
            x2: 0,
            y2: 0,
            x3: 0,
            y3: 0,
          },
          mouse: {
            x: 0,
            y: 0,
          },
          nowPointIndex: 0,
          tags: [],
        },
        methods: {
          async PostWalk() {
            this.nextPoint()
            console.log(this.input.x, this.input.y)
            console.log(this.input.x1, this.input.y1)
            console.log(this.input.x2, this.input.y2)
            console.log(this.input.x3, this.input.y3)
            // const res = await axios.post(
            //   "http://120.105.161.209:3000/walk",
            //   this.input
            // )
            // this.input = {
            //  x: 0,
            // y: 0,
            // x1: 0,
            // y1: 0,
            // x2: 0,
            // y2: 0,
            // x3: 0,
            // y3: 0,
            // }
          },
          nextPoint() {
            switch (this.nowPointIndex) {
              case 0:
                this.input.x = this.mouse.x
                this.input.y = this.mouse.y
                this.mouse = {
                  x: 0,
                  y: 0,
                }
                break
              case 1:
                this.input.x1 = this.mouse.x
                this.input.y1 = this.mouse.y
                this.mouse = {
                  x: 0,
                  y: 0,
                }
                break
              case 2:
                this.input.x2 = this.mouse.x
                this.input.y2 = this.mouse.y
                this.mouse = {
                  x: 0,
                  y: 0,
                }
                break
              case 3:
                this.input.x3 = this.mouse.x
                this.input.y3 = this.mouse.y
                this.mouse = {
                  x: 0,
                  y: 0,
                }
                break
              default:
                break
            }
            this.nowPointIndex++
            this.nowPointIndex %= 4
          },
          getPosition(element) {
            var x = 0
            var y = 0
            // 搭配上面的示意圖可比較輕鬆理解為何要這麼計算
            while (element) {
              x += element.offsetLeft - element.scrollLeft + element.clientLeft
              y += element.offsetTop - element.scrollLeft + element.clientTop
              element = element.offsetParent
            }

            return { x: x, y: y }
          },
          clickPosition(event) {
            var elem = document.querySelector("canvas")
            var position = this.getPosition(elem)
            this.mouse = {
              x: ((event.pageX - position.x) / (8.27 * 2)).toFixed(2),
              y: ((event.pageY - position.y) / (7.7 * 2)).toFixed(2),
            }
          },
          async fetch() {
            const res = await axios.get(
              "http://120.105.161.209:3000/position-tags?query=%7B%22where%22%3A%7B%7D%2C%22limit%22%3A100%2C%22page%22%3A1%7D"
            )
            this.tags = res.data.data
          },
          draw() {
            console.log(this.tags)
            console.log("go draw")
            this.tags.forEach((el) => {
              let ctx7 = canvas.getContext("2d")
              ctx7.fillStyle = "#FF0000"
              ctx7.beginPath()
              ctx7.arc(
                el.x * 8.27 * 2,
                400 * 2 - el.y * 7.7 * 2,
                2,
                0,
                2 * Math.PI
              )
              ctx7.stroke()
              ctx7.fill()
            })
          },
          prePoint() {
            this.nowPointIndex--
          },
          async push() {
            var c = document.getElementById("canvas")
            var ctx = c.getContext("2d")
            ctx.translate(0.5, 0.5)
            ctx.imageSmoothingEnabled = false
            // this.draw();
            var image = new Image()
            image.src = "http://120.105.161.209/Nursemaid/image/7F.png"
            image.onload = async function () {
              if (image.complete) {
                await ctx.drawImage(this, 0, 0, c.scrollWidth, c.scrollHeight)
                console.log("complete")
                await app.draw()
              }
            }
          },
        },
        async created() {
          await this.fetch()
          await this.push()
        },
      })
    </script>
  </body>
</html>
