<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Tags</title>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <style>
      body {
        background-color: antiquewhite;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="container">
        <h1>請先選擇地點</h1>
        <div class="row">
          <canvas id="canvas" @click="clickPosition" height="400"></canvas>
        </div>
        <div class="row">
          <div
            class="form-group col-2"
            v-for="(item,index) in TagData[0]"
            v-if="index!='updatedAt' && index!='_id'"
          >
            <div>
              <label for="">{{index}}</label>
              <input
                v-if="index!='isTag' && index!='position'"
                type="text"
                class="form-control"
                :name="index"
                aria-describedby="helpId"
                placeholder=""
                v-model="input[index]"
              />
              <select
                class="form-control"
                v-if="index=='isTag'"
                v-model="input[index]"
              >
                <option>true</option>
                <option>false</option>
              </select>
              <select
                class="form-control"
                v-if="index=='position'"
                v-model="input[index]"
                @change="changePos"
              >
                <option v-for="item in Position">{{item.position}}</option>
              </select>
            </div>
          </div>
          <button
            class="btn btn-primary d-flex align-items-center my-auto"
            @click="add"
            style="height: 50px"
          >
            送出
          </button>
        </div>
      </div>

      <div class="container">
        <div class="row text-center">
          <div class="col-12 d-flex justify-content-center">
            <table class="table" v-if="TagData.length">
              <thead class="thead-inverse">
                <tr>
                  <th
                    v-for="(item,index) in TagData[0]"
                    v-if="index!='_id' && index!='updatedAt'"
                  >
                    {{index}}
                  </th>
                  <th>刪除</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(item1,index1) in TagData">
                  <template v-for="(item,index) in TagData[0]">
                    <td scope="row" v-if="index!='_id' && index!='updatedAt'">
                      <input
                        type="text"
                        v-model="item1[index]"
                        style="width: 70px"
                        :style="{ width: index=='mac'?'150px':'50px'}"
                      />
                    </td>
                  </template>
                  <td>
                    <button class="btn btn-info" @click="putTag(item1)">
                      修改
                    </button>
                    <button @click="del(item1._id)" class="btn btn-danger">
                      刪除
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.11/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.js"></script>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script>
      app = new Vue({
        el: "#app",
        data() {
          return {
            TagData: [],
            canavs: {
              width: 0,
              height: 0,
            },
            input: {
              x: 0,
              y: 0,
              rssi: "60",
            },
            Position: [],
            target: {},
          }
        },
        methods: {
          getPosition(element) {
            var x = 0
            var y = 0
            // 搭配上面的示意圖可比較輕鬆理解為何要這麼計算
            while (element) {
              x += element.offsetLeft - element.scrollLeft + element.clientLeft
              y += element.offsetTop - element.scrollLeft + element.clientTop
              element = element.offsetParent
            }

            return { x: x, y: y }
          },
          async drawTag() {
            const res = await axios.get(
              `http://120.105.161.209:3000/position-tags?query={"where":{"position":"${this.input.position}"},"limit":100,"page":1}`
            )
            res.data.data.forEach((el) => {
              text = el.mac.substring(12, 17)
              this.drawPoint(el.x, el.y, "#000000", text, "#FF0000", 5)
            })
          },
          caculationPoint(x, y) {
            Point = {
              x: (8.46 / 400) * this.canavs.x * x,
              y: this.canavs.y - (7.68 / 400) * this.canavs.y * y,
            }
            return Point
          },
          drawPoint(x, y, Textcolor, text, pointColor, pointSize) {
            let ctx = canvas.getContext("2d")
            ctx.fillStyle = pointColor
            ctx.beginPath()
            let point = this.caculationPoint(x, y)
            ctx.arc(point.x, point.y, pointSize, 0, 2 * Math.PI)
            ctx.stroke()
            ctx.fill()
            ctx.fillStyle = Textcolor
            ctx.font = "14px Arial"
            ctx.fillText(text, point.x - 20, point.y - 10)
          },
          async drawCanvasImage(val) {
            let c = document.getElementById("canvas")
            let ctx = c.getContext("2d")
            ctx.imageSmoothingEnabled = false
            let image = new Image()
            image.src = val
            image.onload = async function () {
              if (image.complete) {
                await ctx.drawImage(this, 0, 0, c.scrollWidth, c.scrollHeight)
                console.log("complete")
                await app.drawTag()
              }
            }
          },
          setCanvas(size) {
            let c = document.getElementById("canvas")
            c.width = size
            c.height = size
            this.getCanvas()
          },
          getCanvas() {
            let c = document.getElementById("canvas")
            this.canavs.x = c.scrollWidth
            this.canavs.y = c.scrollHeight
          },
          async changePos() {
            const res = await axios.get(
              `http://120.105.161.209:3000/position?query={"where":{"position":"${this.input.position}"},"limit":100,"page":1}`
            )
            this.setCanvas(400)
            this.drawCanvasImage(res.data.data[0].img)
          },
          clickPosition(event) {
            console.log("click")
            var elem = document.querySelector("canvas")
            var position = this.getPosition(elem)
            this.mouse = {
              x: (
                (event.pageX - position.x) /
                ((8.46 / 400) * this.canavs.x)
              ).toFixed(2),
              y: (
                (this.canavs.y - event.pageY + position.y) /
                ((7.7 / 400) * this.canavs.y)
              ).toFixed(2),
            }
            this.input.x = this.mouse.x
            this.input.y = this.mouse.y
          },
          async add() {
            const res = await axios.post(
              "http://120.105.161.209:3000/position-tags",
              this.input
            )
            this.input.x = 0
            this.input.y = 0
            await this.changePos()
            await this.fecth()
          },
          async putTag(val) {
            console.log(val)
            const res = await axios.put(
              "http://120.105.161.209:3000/position-tags/" + val._id,
              val
            )
            await this.changePos()
            await this.fecth()
          },
          async del(id) {
            console.log(id)
            console.log(id)
            const res = await axios.delete(
              "http://120.105.161.209:3000/position-tags/" + id
            )
            await this.changePos()
            this.fecth()
          },
          async fecthPosition() {
            const res = await axios.get(
              "http://120.105.161.209:3000/position?query=%7B%22limit%22%3A100%7D"
            )
            this.Position = res.data.data
          },
          async fecth() {
            const res = await axios.get(
              "http://120.105.161.209:3000/position-tags?query=%7B%22limit%22%3A100%7D"
            )
            this.TagData = res.data.data
            this.TagData.forEach((el) => {
              delete el.createdAt
              delete el.__v
            })
          },
        },
        async created() {
          this.fecth()
          this.fecthPosition()
        },
      })
    </script>
  </body>
</html>
